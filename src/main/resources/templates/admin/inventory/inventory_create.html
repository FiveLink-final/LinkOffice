<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
    xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
    layout:decorate="~{include/layout}">
<meta charset="UTF-8">
<th:block layout:fragment="content">
    <link th:href="@{/css/admin/inventory/inventory_create.css}" rel="stylesheet" type="text/css">
    <style>
        /* 필요하다면 CSS를 추가하세요 */
    </style>

<section>
    <div style="width: 80%; margin: 0 auto;">
    <h1>비품 등록</h1>
    <hr>

    <form action="/submit-inventory" method="POST">
    <!-- CSRF 토큰 추가 -->
    <input type="hidden" name="_csrf" th:value="${_csrf.token}" id="csrfToken"/>

    <div class="form-group">
        <label for="department">부서 :</label>
        <select id="department" name="department">
            <option value="">부서 선택</option>
            <option th:each="department : ${departments}" 
                    th:value="${department.department_no}" 
                    th:text="${department.department_name}">
            </option>
        </select>
    </div>

    <div class="form-group">
        <label for="date">일자 :</label>
        <input type="date" id="date" name="date">
    </div>

    <div class="form-group">
        <label for="category">카테고리명 :</label>
        <input type="text" id="category" name="category" readonly>
        <button type="button" id="openModalBtn">카테고리 선택</button>
        <button type="button" id="openRegisterModalBtn">카테고리 등록</button> <!-- 카테고리 등록 버튼 추가 -->
    </div>

    <div class="form-group">
        <label for="inventoryName">비품명 :</label>
        <input type="text" id="inventoryName" name="inventoryName">
    </div>

    <div class="form-group">
        <label for="inventoryLocation">보관위치 :</label>
        <input type="text" id="inventoryLocation" name="inventoryLocation">
    </div>

    <div class="form-group">
        <label for="inventoryPrice">가격 :</label>
        <input type="text" id="inventoryPrice" name="inventoryPrice">
    </div>

    <div class="form-group">
        <label for="inventoryManager">관리자 :</label>
        <input type="text" th:value="${manager} + ' 관리자'" id="inventoryManager" name="inventoryManager" readonly>
    </div>

    <div class="form-group">
        <label for="inventoryQuantity">수량 :</label>
        <input type="text" id="inventoryQuantity" name="inventoryQuantity">
    </div>

    <div class="register-button">
        <button type="submit">등록</button>
    </div>
</form>

    <!-- 카테고리 선택 모달 -->
    <div id="myModal" class="modal modal-select">
        <div class="modal-content">
            <span class="close">&times;</span>
            <h3>카테고리 선택</h3>
            <div id="categoryList">
                <!-- 카테고리 동적 추가 영역 -->
            </div>

            <div class="modal-buttons">
                <button type="button" class="confirm-button" id="confirmBtn">확인</button>
                <button type="button" class="cancel-button" id="cancelBtn">취소</button>
            </div>
        </div>
    </div>

    <!-- 카테고리 등록 모달 -->
    <div id="registerModal" class="modal modal-register">
        <div class="modal-content">
            <span class="closeRegisterModal">&times;</span>
            <h3>카테고리 등록</h3>
            <form id="categoryForm">
                <div class="form-group">
                    <label for="newCategory">카테고리 명 :</label>
                    <input type="text" id="newCategory" name="newCategory">
                </div>
            </form>
            <div class="modal-buttons">
                <button type="button" class="confirm-register" id="registerCategoryBtn">등록</button>
                <button type="button" class="cancel-register" id="cancelRegisterBtn">취소</button>
            </div>
        </div>
    </div>

    </div>
</section>

    <script>
        // 카테고리 선택 모달
        var modal = document.getElementById("myModal");
        var btn = document.getElementById("openModalBtn");
        var span = document.getElementsByClassName("close")[0];
        var confirmBtn = document.getElementById("confirmBtn");
        var cancelBtn = document.getElementById("cancelBtn"); // 카테고리 선택 모달 취소 버튼

        btn.onclick = function() {
            modal.style.display = "block";

            // 카테고리 데이터를 불러와서 모달에 추가
            var xhr = new XMLHttpRequest();
            xhr.open('GET', '/inventory/categories', true);
            xhr.onload = function() {
                if (xhr.status === 200) {
                    var categories = JSON.parse(xhr.responseText);
                    var categoryList = document.getElementById('categoryList');
                    categoryList.innerHTML = ''; // 기존 리스트 제거

                    for (var i = 0; i < categories.length; i++) {
                        var listItem = document.createElement('div');
                        listItem.className = 'category-item';
                        listItem.innerHTML = `
                            <input type="radio" id="category_${categories[i]}" name="category" value="${categories[i]}" class="category-item">
                            <label for="category_${categories[i]}">${categories[i]}</label>
                        `;
                        categoryList.appendChild(listItem);
                    }
                }
            };
            xhr.onerror = function() {
                alert('카테고리 목록을 불러오는 중 오류가 발생했습니다.');
            };
            xhr.send();
        };

        span.onclick = function() {
            modal.style.display = "none";
        };

        window.onclick = function(event) {
            if (event.target == modal) {
                modal.style.display = "none";
            }
        };

        confirmBtn.onclick = function() {
            var selectedCategory = document.querySelector('input[name="category"]:checked');
            if (selectedCategory) {
                document.getElementById("category").value = selectedCategory.value;
                modal.style.display = "none";
            }
        };

        // 카테고리 선택 취소 버튼 클릭 시 모달 닫기
        cancelBtn.onclick = function() {
            modal.style.display = "none";
        };

        // 카테고리 등록 모달
        var registerModal = document.getElementById("registerModal");
        var openRegisterModalBtn = document.getElementById("openRegisterModalBtn");
        var closeRegisterModal = document.getElementsByClassName("closeRegisterModal")[0];
        var registerCategoryBtn = document.getElementById("registerCategoryBtn");
        var cancelRegisterBtn = document.getElementById("cancelRegisterBtn"); // 카테고리 등록 모달 취소 버튼

        // 카테고리 등록 모달 열기
        openRegisterModalBtn.onclick = function() {
            registerModal.style.display = "block";
        };

        // 등록 모달 닫기
        closeRegisterModal.onclick = function() {
            registerModal.style.display = "none";
        };

        // 모달 외부 클릭 시 닫기
        window.onclick = function(event) {
            if (event.target == registerModal) {
                registerModal.style.display = "none";
            }
        };

        // 카테고리 등록 버튼 클릭 시
        registerCategoryBtn.onclick = function() {
            registerCategory();  // 클릭 시 함수 호출
        };

        // 카테고리 등록 모달 취소 버튼 클릭 시 모달 닫기
        cancelRegisterBtn.onclick = function() {
            registerModal.style.display = "none";
        };

     // 카테고리 등록 함수
        function registerCategory() {
            var newCategory = document.getElementById("newCategory").value;
            var csrfToken = document.getElementById('csrfToken').value;
            if (newCategory) {
                var xhr = new XMLHttpRequest();
                xhr.open('POST', '/inventory/register-category', true);
                xhr.setRequestHeader('Content-Type', 'application/json');
                xhr.setRequestHeader('X-CSRF-TOKEN', csrfToken);
                xhr.onload = function() {
                    if (xhr.status === 200) {
                        alert(xhr.responseText);  
                        // 카테고리 등록이 성공적으로 완료되면 모달 닫기
                        registerModal.style.display = "none";
                    } else {
                        alert('카테고리 등록 실패');
                    }
                };
                xhr.onerror = function() {
                    alert('카테고리 등록 중 오류 발생');
                };
                xhr.send(JSON.stringify({ inventory_category_name: newCategory }));
            } else {
                alert('카테고리 이름을 입력하세요.');
            }
        }
    </script>
</th:block>
</html>
