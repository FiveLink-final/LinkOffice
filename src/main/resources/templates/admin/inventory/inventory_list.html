<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
    xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
    layout:decorate="~{include/layout}">
<meta charset="UTF-8">
<th:block layout:fragment="content">
    <link th:href="@{/css/admin/inventory/inventory_list.css}" rel="stylesheet" type="text/css">
    <!-- DataTables CSS -->
    <link th:href="@{/css/datatable.css}" rel="stylesheet" type="text/css">
    <style>
        td.details-control {
            background: url('https://cdn.datatables.net/1.11.5/images/sort_desc.png') no-repeat center center;
            cursor: pointer;
        }
        tr.shown td.details-control {
            background: url('https://cdn.datatables.net/1.11.5/images/sort_asc.png') no-repeat center center;
        }

        /* child-row를 위한 스타일 */
        .child-row {
            background-color: #f9f9f9;
        }

        .child-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 10px;
        }

        .child-table th, .child-table td {
            padding: 8px;
            border: 1px solid #ddd;
            text-align: left;
        }   
    </style>
<section>
    <div style="width: 80%; margin: 0 auto;">
    <h1 style="border-bottom: 2px solid #000; padding-bottom: 5px;">비품 목록</h1>
    <br>
    <!-- 부서 선택을 테이블 위에 두기 -->
    <div id="departmentSelectContainer">
            <select id="departmentSelect" onchange="fetchInventoryByDepartment()">
                <option value="">부서 선택</option>
                <option th:each="department : ${departments}" 
                    th:value="${department.department_no}" 
                    th:text="${department.department_name}">
                </option>
            </select>
        </div>

        <!-- 카테고리 목록 테이블 -->
        <table id="example" class="display">
            <thead>
                <tr>
                    <th></th>
                    <th>카테고리 번호</th>
                    <th>카테고리명</th>
                    <th>평균 가격</th>
                    <th>총 개수</th>
                    <th>최근 위치</th>
                    <th>최근 등록일자</th>
                </tr>
            </thead>
            <tbody id="categoryTableBody">
                <!-- 카테고리 목록이 여기에 동적으로 추가됩니다 -->
            </tbody>
        </table>
    </div>
</section>

<script>
    // 부서 선택 시 해당 부서의 카테고리를 가져오는 함수
    function fetchInventoryByDepartment() {
    var departmentNo = document.getElementById("departmentSelect").value;
    var table = $('#example').DataTable();

    if (!departmentNo) {
        table.clear(); 
        table.settings()[0].oLanguage.sEmptyTable = "부서를 선택해주세요";
        table.draw();  
        return;  
    }

    // 부서가 선택된 경우에만 데이터를 불러옴
    var xhr = new XMLHttpRequest();
    xhr.open('GET', '/inventory/department/' + departmentNo, true);

    xhr.onreadystatechange = function() {
        if (xhr.readyState === XMLHttpRequest.DONE) {
            if (xhr.status === 200) {
                var data = JSON.parse(xhr.responseText);
                console.log("Received department data:", data);  
                updateCategoryTable(data);
            } else {
                console.error('요청 실패:', xhr.status, xhr.statusText);
            }
        }
    };

    xhr.send();
}

    // 카테고리 데이터를 테이블에 추가하는 함수
    function updateCategoryTable(data) {
        var table = $('#example').DataTable();
        table.clear(); 

        data.forEach(function(item,index) {
            var row = `
                <tr data-inventory_no="${item.inventory_category_no}">
                    <td class="details-control"></td>
                    <td>${index+1}</td>
                    <td>${item.inventory_category_name}</td>
                    <td>${item.inventory_price}</td> 
                    <td>${item.inventory_quantity}</td> 
                    <td>${item.inventory_location}</td> 
                    <td>${item.inventory_purchase_date}</td> 
                </tr>
            `;
            table.row.add($(row)).draw(false);
        });
    }

    // 세부 비품 목록을 child row로 표시하는 함수 (실제 데이터를 받아서 사용)
    function format(inventory_category_no, row) {
        var departmentNo = document.getElementById("departmentSelect").value;
        var detailsHtml = '<table class="child-table"><thead><tr><th>번호</th><th>비품명</th><th>가격</th><th>개수</th><th>위치</th><th>구입일자</th></tr></thead><tbody>';

        fetchInventoryByCategoryAndDepartment(inventory_category_no, departmentNo, function(data) {
            console.log("Received inventory data:", data);

            if (Array.isArray(data) && data.length > 0) {
                data.forEach(function(item, index) {
                    detailsHtml += `
                        <tr>
                            <td>${index + 1}</td>
                            <td>${item.inventory_name}</td>
                            <td>${item.inventory_price}</td>
                            <td>${item.inventory_quantity}</td>
                            <td>${item.inventory_location}</td>
                            <td>${item.inventory_purchase_date}</td>
                        </tr>
                    `;
                });
            } else {
                detailsHtml += '<tr><td colspan="6">세부 정보가 없습니다.</td></tr>';
            }
            detailsHtml += '</tbody></table>';
            row.child(detailsHtml).show();
        });
    }

    // 특정 카테고리 및 부서에 따른 비품 데이터를 가져오는 함수
    function fetchInventoryByCategoryAndDepartment(inventory_category_no, departmentNo, callback) {
        var xhr = new XMLHttpRequest();
        xhr.open('GET', '/inventory/category/' + inventory_category_no + '/department/' + departmentNo, true);

        xhr.onreadystatechange = function() {
            if (xhr.readyState === XMLHttpRequest.DONE) {
                if (xhr.status === 200) {
                    try {
                        var data = JSON.parse(xhr.responseText);
                        callback(data);  
                    } catch (e) {
                        console.error('Error parsing JSON:', e);
                    }
                } else {
                    console.error('요청 실패:', xhr.status, xhr.statusText);
                }
            }
        };

        xhr.send(); 
    }

    $(document).ready(function() {
        // DataTables 설정
        var table = $('#example').DataTable({
            "paging": true,
            "searching": true,
            "ordering": true,
            "info": false,
            "autoWidth": false,
            "language": {
                "emptyTable": "부서를 선택해주세요." 
            }
        });
        $('.dataTables_length').remove();
   
		
        // 세부 비품 표시 클릭 이벤트
        $('#example tbody').on('click', 'td.details-control', function() {
            var tr = $(this).closest('tr');
            var row = table.row(tr);
            var inventory_category_no = tr.attr('data-inventory_no');

            if (row.child.isShown()) {             
                row.child.hide();
                tr.removeClass('shown');
            } else {
                format(inventory_category_no, row);
                tr.addClass('shown');
            }
        });
    });
</script>

<!-- jQuery -->
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<!-- DataTables JS -->
<script src="https://cdn.datatables.net/1.11.5/js/jquery.dataTables.min.js"></script>
</th:block>
</html>
