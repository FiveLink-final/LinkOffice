<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{include/layout}">
<th:block layout:fragment="content">
    <link th:href="@{/css/employee/survey/survey_question_result.css}" rel="stylesheet" type="text/css">
    <section>
        <h1>설문 상세</h1>
        <div class="container">
            <div class="header">
                <div th:if="${dto != null}">
                    <h1 th:text="${dto.survey_title}"></h1>
                    <br>
                    <p>작성자: <span th:text="${dto.member_name}"></span></p>
                    <p>작성일: <span th:text="${dto.survey_create_date}"></span></p>
                    <p>설문 기간: <span th:text="${dto.survey_start_date} + ' ~ ' + ${dto.survey_end_date}"></span></p>
                    <p>설문 상태: <span th:text="${dto.survey_status == 0 ? '진행 중' : '종료'}"></span></p>

                    <!-- 참여 통계 -->
                    <div class="stats">
                        <div class="stat">
                            <p>전체 참여자</p>
                            <h2 th:text="${totalParticipants}"></h2>
                        </div>
                        <div class="stat">
                            <p>참여 완료</p>
                            <h2 th:text="${completedParticipants}"></h2>
                        </div>
                        <div class="stat">
                            <p>미참여</p>
                            <h2 th:text="${notParticipatedParticipants}"></h2>
                        </div>
                    </div>
                </div>
            </div>
            <br>

            <div class="questions">
                <div class="question" th:each="question, iterStat : ${questions}">
                    <!-- 질문 번호 및 텍스트 -->
                    <p>
                        <strong th:text="${iterStat.count + '.'}"></strong> <span th:text="${question.survey_question_text}"></span>
                    </p>

                    <!-- 객관식 질문일 경우 -->
                    <div th:if="${question.survey_question_type == 0}">
                        <!-- 참여자 및 참여율 요약 -->
                        <div class="participation-summary">
                            <p>
                                전체 참여자: <span class="total-participants" th:text="${totalParticipants}"></span> 
                                <span class="spacer"></span> 참여율: <span class="participation-rate" th:text="${participationRates[question.survey_question_no] + '%'}"></span>
                            </p>
                            <div th:id="'piechart-' + ${question.survey_question_no}" style="width: 600px; height: 400px;"></div>
                        </div>
                    </div>

                    <!-- 주관식 질문일 경우 -->
                    <div th:if="${question.survey_question_type == 1}">
                        <div class="participation-summary">
                            <p>
                                전체 참여자: <span class="total-participants" th:text="${totalParticipants}"></span>
                                <span class="spacer"></span> 참여율: <span class="participation-rate" th:text="${participationRates[question.survey_question_no] + '%'}"></span>
                            </p>
                        </div>
                    </div>
                </div>
            </div>
    </section>

   <!-- 차트 그리기 위한 데이터 -->
<script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>

<script type="text/javascript" th:inline="javascript">
    // 구글 차트 로드
    google.charts.load('current', {'packages':['corechart']});
    google.charts.setOnLoadCallback(drawCharts);

    function drawCharts() {
        // Thymeleaf에서 서버로부터 전달된 데이터를 가져옵니다.
        const optionAnswerCounts = /*[[${optionAnswerCounts}]]*/ {};  // 서버에서 전달된 데이터 사용

        console.log(optionAnswerCounts);  // 데이터가 제대로 넘어오는지 확인

        // 질문 번호별로 데이터 처리
        for (const questionNo in optionAnswerCounts) {
            let chartData = [['Option', 'Votes']];  // 구글 차트 형식에 맞는 2차원 배열 생성

            // 옵션별로 데이터 추가
            optionAnswerCounts[questionNo].forEach(option => {
                const optionAnswer = option[0];  // 설문 옵션 (예: "네", "아니요")
                const answerCount = option[1];   // 해당 옵션을 선택한 응답자 수
                chartData.push([optionAnswer, answerCount]);  // 차트에 들어갈 데이터 배열로 구성
            });

            // 차트를 그릴 데이터를 설정합니다.
            var data = google.visualization.arrayToDataTable(chartData);

            var options = {
                title: 'Survey Question ' + questionNo + ' Results',
                is3D: true,  // 차트를 3D로 표시
                pieSliceText: 'value'
            };

            // 각 질문별로 차트를 표시할 위치 지정 (div id는 동적으로 questionNo 사용)
            var chart = new google.visualization.PieChart(document.getElementById('piechart-' + questionNo));
            chart.draw(data, options);
        }
    }
</script>

</th:block>
</html>
