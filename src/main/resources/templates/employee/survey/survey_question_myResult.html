<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
	xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
	layout:decorate="~{include/layout}">
<th:block layout:fragment="content">
	<link th:href="@{/css/employee/survey/survey_question_myResult.css}" rel="stylesheet" type="text/css">

	<section>
		<h1>설문 상세</h1>
		<div class="container">
			<div class="header">
				<div th:if="${dto != null}">
					<h1 th:text="${dto.survey_title}"></h1>
					<br>
					<p>작성자: <span th:text="${dto.member_name}"></span></p>
					<p>작성일: <span th:text="${dto.survey_create_date}"></span></p>
					<p>설문 기간: <span th:text="${dto.survey_start_date} + ' ~ ' + ${dto.survey_end_date}"></span></p>
					<p>설문 상태: <span th:text="${dto.survey_status == 0 ? '진행 중' : '종료'}"></span></p>

					<!-- 참여 통계 -->
					<div class="stats">
						<div class="stat">
							<p>전체 참여자</p>
							<h2 th:text="${totalParticipants}"></h2>
						</div>
						<div class="stat">
							<p>참여 완료</p>
							<h2 th:text="${completedParticipants}"></h2>
						</div>
						<div class="stat">
							<p>미참여</p>
							<h2 th:text="${notParticipatedParticipants}"></h2>
						</div>
					</div>
				</div>
			</div>
			<br>

			<!-- 질문 출력 -->
			<div class="questions">
				<div class="question" th:each="question, iterStat : ${questions}">
					<p>
						<strong th:text="${iterStat.count + '.'}"></strong> <span th:text="${question.survey_question_text}"></span>
					</p>

					<!-- 선택형 질문인 경우 -->
					<div th:if="${question.survey_question_type == 0}">
						<div class="participation-summary">
							<p>전체 참여자: <span class="total-participants" th:text="${totalParticipants}"></span> 참여율: <span class="participation-rate" th:text="${participationRates[question.survey_question_no] + '%'}"></span></p>
						</div>
						<!-- 차트 렌더링 -->
						<div th:id="'piechart-' + ${question.survey_question_no}" style="width: 600px; height: 400px;"></div>
					</div>

					<!-- 주관식 질문인 경우 -->
					<div th:if="${question.survey_question_type == 1}">
						<div class="participation-summary">
							<p>전체 참여자: <span class="total-participants" th:text="${totalParticipants}"></span> 참여율: <span class="participation-rate" th:text="${participationRates[question.survey_question_no] + '%'}"></span></p>
						</div>

						<!-- 주관식 응답 출력 -->
						<table class="survey-table">
							<thead>
								<tr>
									<th>이름</th>
									<th>응답</th>
								</tr>
							</thead>
							<tbody>
								<tr th:each="textAnswer : ${textAnswers[question.survey_question_no]}">
									<td th:text="${textAnswer[0]}"></td>
									<td th:text="${textAnswer[1]}"></td>
								</tr>
							</tbody>
						</table>
					</div>
				</div>
			</div>
		</div>
	</section>

	<!-- 구글 차트 스크립트 추가 -->
	<script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>
	<script type="text/javascript" th:inline="javascript">
        google.charts.load('current', {'packages': ['corechart']});
        google.charts.setOnLoadCallback(drawCharts);

        function drawCharts() {
            let chartData = /*[[${chartData}]]*/ {};
            for (const [questionNo, data] of Object.entries(chartData)) {
                drawChart(questionNo, data);
            }
        }

        function drawChart(questionNo, chartData) {
            var data = google.visualization.arrayToDataTable(chartData);
            var options = {
                is3D: true,
                width: 600,
                height: 400,
                pieSliceText: 'label', 
                chartArea: { width: '90%', height: '75%' }
            };
            var chart = new google.visualization.PieChart(document.getElementById('piechart-' + questionNo));
            chart.draw(data, options);
        }
    </script>
</th:block>
</html>
